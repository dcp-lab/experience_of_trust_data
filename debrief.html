<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Information Sheet</title>
<style>
    body { font-family: Arial, sans-serif; padding: 40px; max-width: 900px; margin: auto; line-height: 1.6; }
    h2, h3 { color: #003366; }
    button { margin-top: 40px; padding: 12px 24px; font-size: 16px; }
  </style>
</head>
<body>
<h2>Debrief</h2>
<p><b>Thank you for participating in this experiment.</b></p>
<p>The purpose of this study is to <b>explore how receiving trust in economic interactions impacts individuals' well-being.</b></p>
<p>In particular, we are interested in <b>how being trusted by another person during a decision-making task influences emotional affect and anxiety levels.</b>
<p>You were deliberately assigned the role of <b>Player B</b>, and in each trial you received an amount (tripled) from another participant, simulating a situation of trust. 
  Your responses during the game and in the surveys will help us better understand the psychological effects of trust-based interactions.</p>
<p>All of your responses have been recorded and anonymized. If you have any questions or wish to know more about the study, feel free to contact the research team at <i>dcp-lab@ucl.ac.uk</i>.</p>
<p><b>Please press "End Experiment" button to complete the experiment and be redirected to Prolific.</b></p>
<button onclick="endExperiment()">End Experiment</button>

<script>
function endExperiment() {
  let rows = ["Survey,Item,Value"];

  const condition = localStorage.getItem("Condition");
  if (condition) rows.push(`Condition,GameType,${condition}`);

  const prolificID = localStorage.getItem("ProlificID");
  if (prolificID) rows.push(`Participant,ProlificID,${prolificID}`);

  const estimate = JSON.parse(localStorage.getItem("Estimate") || "{}");
  if (estimate.averageExpected !== undefined) {
    rows.push(`Estimate,ExpectedAverage,${estimate.averageExpected}`);
  }

  const received = JSON.parse(localStorage.getItem("received") || "[]");
  const sentBack = JSON.parse(localStorage.getItem("sentBack") || "[]");
  const before = received.map(val => val + 12);

  rows.push(`GameResults,amounts_received,"[${received.join(", ")}]"`);
  rows.push(`GameResults,total_amount_in_hand_before_playing,"[${before.join(", ")}]"`);
  rows.push(`GameResults,amounts_sent_back,"[${sentBack.join(", ")}]"`);

  if (before.length && sentBack.length && before.length === sentBack.length) {
    const after = before.map((val, i) => val - sentBack[i]);
    rows.push(`GameResults,total_amount_in_hand_after_playing,"[${after.join(", ")}]"`);
    const totalAfterPlaying = after.reduce((sum, val) => sum + val, 0);
    const bonus = (totalAfterPlaying * 0.002).toFixed(2);
    rows.push(`GameResults,bonus,${bonus}`);
  }

  if (received.length > 0) {
    const averageReceived = received.reduce((sum, val) => sum + val, 0) / received.length;
    const actualAverage = averageReceived / 3;
    rows.push(`GameResults,actual_average,${actualAverage.toFixed(2)}`);
    const correctedDifference = actualAverage - (estimate.averageExpected || 0);
    rows.push(`GameResults,difference,${correctedDifference.toFixed(2)}`);
  } else {
    rows.push(`GameResults,actual_average,NaN`);
    rows.push(`GameResults,difference,NaN`);
  }

  const surveys = ["SSVS", "STAIS", "STAIS_Post", "PANAS", "PANAS_Post"];
  surveys.forEach(survey => {
    const data = JSON.parse(localStorage.getItem(survey) || "null");
    if (!data) return;
    if (Array.isArray(data)) {
      data.forEach((item, index) => {
        if (typeof item === 'object') {
          Object.entries(item).forEach(([key, value]) => {
            rows.push(`${survey},${key},${value}`);
          });
        } else {
          rows.push(`${survey},Item${index + 1},${item}`);
        }
      });
    } else if (typeof data === 'object') {
      Object.entries(data).forEach(([key, value]) => {
        rows.push(`${survey},${key},${value}`);
      });
    }
  });

  const timings = [
    ["ssvsDuration", "ssvsDurationMs"],
    ["panasDuration", "panasDurationMs"],
    ["staisDuration", "staisDurationMs"],
    ["panasPostDuration", "panasPostDurationMs"],
    ["staisPostDuration", "staisPostDurationMs"]
  ];
  timings.forEach(([key, label]) => {
    const val = localStorage.getItem(key);
    if (val) rows.push(`Timing,${label},${val}`);
  });

  const trustDurations = JSON.parse(localStorage.getItem("trustDurations") || "[]");
  if (trustDurations.length > 0) {
    rows.push(`Timing,TrustTrialDurations,"[${trustDurations.join(", ")}]"`);
  }

  const dictatorDurations = JSON.parse(localStorage.getItem("dictatorDurations") || "[]");
  if (dictatorDurations.length > 0) {
    rows.push(`Timing,DictatorTrialDurations,"[${dictatorDurations.join(", ")}]"`);
  }

  // Download the CSV
  const csvContent = "data:text/csv;charset=utf-8," + rows.join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "survey_results.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  // Redirect to Prolific after delay
  setTimeout(() => {
    window.location.href = "https://app.prolific.com/submissions/complete?cc=72AAC84F";
  }, 2000);
}
</script>

</body>
</html>
